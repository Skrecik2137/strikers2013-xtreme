#include <kamek.h>
#include <snd.h>
#include <buttonhelpers.h>
#include <text.h>
#include <shd_debug.h>
#include <utilitysato.h>
#include "music.h"

// #b84#=もどる #b83#=けってい #b87#=ルールせってい #b88#=そうさ #b85#I1#=Previous track #b86#=Next track 
// but apparently SJIS doensn't exist!
static char s_HelpbarText_SP[] = { 0x23, 0x62, 0x38, 0x34, 0x23, 0x3d, 0x82, 0xe0, 0x82, 0xc7, 0x82, 0xe9, 0x20, 0x23, 0x62, 0x38, 0x33, 0x23, 0x3d, 0x82, 0xaf, 0x82, 0xc1, 0x82, 0xc4, 0x82, 0xa2, 0x20, 0x23, 0x62, 0x38, 0x37, 0x23, 0x3d, 0x83, 0x8b, 0x81, 0x5b, 0x83, 0x8b, 0x82, 0xb9, 0x82, 0xc1, 0x82, 0xc4, 0x82, 0xa2, 0x20, 0x23, 0x62, 0x38, 0x38, 0x23, 0x3d, 0x82, 0xbb, 0x82, 0xa4, 0x82, 0xb3, 0x20, 0x23, 0x49, 0x31, 0x23, 0x62, 0x38, 0x36, 0x23, 0x3d, 0x50, 0x72, 0x65, 0x76, 0x69, 0x6f, 0x75, 0x73, 0x20, 0x74, 0x72, 0x61, 0x63, 0x6b, 0x20, 0x23, 0x62, 0x38, 0x35, 0x23, 0x3d, 0x4e, 0x65, 0x78, 0x74, 0x20, 0x74, 0x72, 0x61, 0x63, 0x6b, };
// #b84#=もどる #b83#=けってい #I1#b85#=Next track #b86#=Previous track
static char s_HelpbarText_Wifi_a[] = { 0x23, 0x62, 0x38, 0x34, 0x23, 0x3d, 0x82, 0xe0, 0x82, 0xc7, 0x82, 0xe9, 0x20, 0x23, 0x62, 0x38, 0x33, 0x23, 0x3d, 0x82, 0xaf, 0x82, 0xc1, 0x82, 0xc4, 0x82, 0xa2, 0x20, 0x23, 0x49, 0x31, 0x23, 0x62, 0x38, 0x35, 0x23, 0x3d, 0x4e, 0x65, 0x78, 0x74, 0x20, 0x74, 0x72, 0x61, 0x63, 0x6b, 0x20, 0x23, 0x62, 0x38, 0x36, 0x23, 0x3d, 0x50, 0x72, 0x65, 0x76, 0x69, 0x6f, 0x75, 0x73, 0x20, 0x74, 0x72, 0x61, 0x63, 0x6b, 0x00 };
// #b83#=けってい #I1#b85#=Next track #b86#=Previous track
static char s_HelpbarText_Wifi_b[] = { 0x23, 0x62, 0x38, 0x33, 0x23, 0x3d, 0x82, 0xaf, 0x82, 0xc1, 0x82, 0xc4, 0x82, 0xa2, 0x20, 0x23, 0x49, 0x31, 0x23, 0x62, 0x38, 0x35, 0x23, 0x3d, 0x4e, 0x65, 0x78, 0x74, 0x20, 0x74, 0x72, 0x61, 0x63, 0x6b, 0x20, 0x23, 0x62, 0x38, 0x36, 0x23, 0x3d, 0x50, 0x72, 0x65, 0x76, 0x69, 0x6f, 0x75, 0x73, 0x20, 0x74, 0x72, 0x61, 0x63, 0x6b, 0x00 };
static char ***s_MainTexts = (char***)0x805131C0;

static int s_CurrentBgm = 0;
static bool s_OneTimeChange = false;
const int bgmMax = sizeof(bgmNames) / sizeof(bgmNames[0]);

int getSndId(const char* defaultBgm) 
{
	if (s_CurrentBgm)
		return wiiSndGetNameToID(bgmNames[s_CurrentBgm - 1]);
	return wiiSndGetNameToID(defaultBgm);
}

int updateCurrentBgm(int argBak) 
{
	if(!s_OneTimeChange) // changes the helpbar text
	{
		char** mainTexts = *s_MainTexts;
		mainTexts[858] = s_HelpbarText_SP;
		mainTexts[530] = s_HelpbarText_Wifi_a;
		mainTexts[531] = s_HelpbarText_Wifi_b;
		s_OneTimeChange = true;
	}

	int currentBgm = s_CurrentBgm;
	bool changed = false;

	if (IsButtonPushed_Ready(0)) // +
	{
		currentBgm++;
		changed = true;
	}
	else if (UtilitySato::isPad(0, 0x1000, UtilitySato::PAD_STATE1)) // -
	{
		currentBgm--;
		changed = true;
	}
	
	if (currentBgm < 0) currentBgm = bgmMax;
	if (currentBgm > bgmMax) currentBgm = 0;

	s_CurrentBgm = currentBgm;
	if (changed)
	{
		// if (s_CurrentBgm)
		//	cprintf("New music: %s\n", bgmNames[s_CurrentBgm - 1]);
		
		int id = getSndId("BGM_M12_TENMAS2_MASTER_01"); 
		SNDBgmPlay_Direct(id);
		SNDSeSysOK(-1);
	}
	return IsButtonPushed_OK(argBak); // default inst
}

void drawBgmName()
{
	char message[50];
	int currentBgm = s_CurrentBgm;

	if (currentBgm > 0)
		sprintf(message, "#j#I1Music Track %03d", currentBgm);
	else if (currentBgm == 0)
	{
		strcpy(message, "#j#I1Default track");
	}
	else
	{
		strcpy(message, "#j#I1Random track");
	}
	disp_zen(message, 20, 20, 65);
}

void SNDBgmPlay_Direct(int id)
{
	if (*IsMusicOn)
		shdBgmLoad(0, id, *IsMusicOn, 1);
	else
		shdBgmStop(0);
}

void onlineDrawHook(CSprStudio* spriteStudio)
{
	spriteStudio->Draw();
	drawBgmName();
}

void resetMusic()
{
	s_CurrentBgm = 0;
}

kmCall(0x80047288, getSndId);
kmCall(0x8010DB88, updateCurrentBgm);
kmCall(0x8025CE40, updateCurrentBgm);
kmBranch(0x8025CB1C, onlineDrawHook);
kmBranch(0x8010E8D4, drawBgmName);
kmBranch(0x8011D608, resetMusic);

// changes helpbar text in online menu
kmWrite32(0x8025CE4C, 0x3B800212);
kmWrite32(0x8025CE60, 0x3b800213);